# ==========================================
# Ultra-Secure .htaccess Configuration (Fixed for Tailwind)
# ==========================================

RewriteEngine On

# ==========================================
# 1. Redirect clean URLs to .html files
# ==========================================
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^([^/]+)/?$ $1.html [L]

# ==========================================
# 2. Custom Error Pages
# ==========================================
ErrorDocument 404 http://mycv.i.ng/error

# ==========================================
# 3. Block access to sensitive files and directories
# ==========================================
<FilesMatch "\.(sql|log|ini|conf|bak|old|tmp)$">
    Require all denied
</Files>
<Files "config.php">
    Require all denied
</Files>
<DirectoryMatch "/(config|logs|backups|temp)/">
    Require all denied
</DirectoryMatch>

# ==========================================
# 4. Block common attack patterns
# ==========================================
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
RewriteCond %{QUERY_STRING} (\.|%2E)(\.|%2E)(\.|%2E) [NC,OR]
RewriteCond %{QUERY_STRING} (union|select|insert|drop|delete|update|cast|create|char|convert|alter|declare|exec|script) [NC]
RewriteRule ^ - [F,L]

# ==========================================
# 5. Block suspicious/bad user agents
# ==========================================
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
RewriteRule ^ - [F,L]

# ==========================================
# 6. CORS Configuration (Locked to trusted origins)
# ==========================================
SetEnvIf Origin "^https://mycv\.i\.ng$" ORIGIN_ALLOWED
SetEnvIf Origin "^https://www\.mycv\.i\.ng$" ORIGIN_ALLOWED
Header always set Access-Control-Allow-Origin "%{ORIGIN}e" env=ORIGIN_ALLOWED
Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

# Handle preflight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# ==========================================
# 7. Security Headers
# ==========================================
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set X-XSS-Protection "1; mode=block"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# âœ… FIXED CSP for Tailwind CDN
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://js.paystack.co; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; connect-src 'self' https://api.paystack.co"

# ==========================================
# 8. Hide Server Information
# ==========================================
Header unset Server
Header unset X-Powered-By
ServerTokens Prod

# ==========================================
# 9. Prevent direct API access from unknown sources
# ==========================================
RewriteCond %{REQUEST_URI} ^/api/
RewriteCond %{HTTP_REFERER} !^https://mycv\.i\.ng [NC]
RewriteCond %{HTTP_REFERER} !^https://www\.mycv\.i\.ng [NC]
RewriteRule ^ - [F,L]

# ==========================================
# 10. File Upload & PHP Limits
# ==========================================
php_value upload_max_filesize 5M
php_value post_max_size 5M
php_value max_execution_time 300
php_value memory_limit 128M

# ==========================================
# 11. Disable dangerous PHP functions
# ==========================================
php_admin_value disable_functions "exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source"
